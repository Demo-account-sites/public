<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>January 2026 Booking Calendar</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the calendar */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .calendar-container {
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            max-width: 950px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            align-items: center;
        }

        .calendar-content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .calendar-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .day-name, .date-cell {
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-radius: 0.5rem;
            font-weight: 500;
        }

        .day-name {
            background-color: #e2e8f0;
            color: #4a5568;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .date-cell {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            font-size: 1.1rem;
            color: #2d3748;
            overflow: hidden;
        }

        .date-cell:hover {
            background-color: #e0f2fe;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            z-index: 10;
        }

        .date-cell.today {
            border: 2px solid #3b82f6;
            background-color: #eff6ff;
            color: #1e40af;
            font-weight: 700;
        }

        .date-cell.selected {
            border: 2px solid #059669;
            background-color: #d1fae5;
            color: #065f46;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .corner-indicator {
            position: absolute;
            width: 0;
            height: 0;
            z-index: 5;
            box-shadow: none;
        }

        .corner-indicator.blue {
            top: 0;
            right: 0;
            border-top: 15px solid #3b82f6;
            border-left: 15px solid transparent;
        }

        .corner-indicator.red {
            bottom: 0;
            right: 0;
            border-bottom: 15px solid #ef4444;
            border-left: 15px solid transparent;
        }

        .corner-indicator.hidden-indicator {
            display: none;
        }

        .side-tab {
            width: 280px;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            flex-shrink: 0;
        }

        .side-tab.show {
            opacity: 1;
            visibility: visible;
        }

        .side-tab-content {
            overflow-y: auto;
            flex-grow: 1;
        }

        .event-item {
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            color: #1e40af;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .event-item strong {
            color: #2563eb;
        }

        .event-book-button {
            background-color: #22c55e;
            color: white;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }

        .event-book-button:hover {
            background-color: #16a34a;
        }

        .book-both-container {
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: center;
        }

        .book-both-button {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            margin-top: 0.5rem;
        }

        .book-both-button:hover {
            background-color: #2563eb;
        }

        @media (max-width: 1024px) {
            .calendar-container {
                flex-direction: column;
                padding: 1.5rem;
                max-width: 600px;
            }
            .side-tab {
                width: 100%;
                margin-top: 1.5rem;
                border-radius: 1rem;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .calendar-container {
                padding: 1rem;
                gap: 1rem;
            }
            .day-name, .date-cell {
                padding: 0.5rem 0.2rem;
                font-size: 0.85rem;
                min-height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <div class="calendar-content-wrapper">
            <div class="calendar-header">
                <h2 class="text-3xl font-bold text-gray-800">January 2026</h2>
                <p class="text-gray-600 mt-1">Select a date to view available events.</p>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <div class="day-name">Mon</div>
                <div class="day-name">Tue</div>
                <div class="day-name">Wed</div>
                <div class="day-name">Thu</div>
                <div class="day-name">Fri</div>
                <div class="day-name">Sat</div>
                <div class="day-name">Sun</div>
            </div>
        </div>

        <div class="side-tab" id="sideTab">
            <h3 class="text-2xl font-semibold text-gray-800" id="sideTabDate"></h3>
            <div class="side-tab-content">
                <div id="eventsView" class="flex flex-col gap-3">
                    <p class="text-gray-500" id="eventsPlaceholder">Hover over a date to see events.</p>
                    <div id="eventsList"></div>
                    <div id="bookBothContainer" class="book-both-container hidden">
                        <p class="text-gray-700 mb-2">Want to book both events?</p>
                        <button id="bookBothButton" class="book-both-button">Book Both Events</button>
                    </div>
                    <p class="text-gray-500 text-sm mt-2" id="loadingStatus"></p>
                </div>
            </div>
            
            <button id="closeSideTab" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 mt-auto">
                Close
            </button>
        </div>
    </div>

    <script>
        const kynrenAvailabilitiesCache = {};
        const parkEntryAvailabilitiesCache = {};

        // Smeetz API Key
        const SMEETZ_API_KEY = 'l5oiXlg5KVI9Sre2JlTY_RIqVJJHVmJjloKZ5hZJFEg';
        const KYREN_OPTION_ID = '7396b084-81e0-4016-9492-acb2e4771c76';
        const PARK_ENTRY_OPTION_ID = '61d3cf87-2092-4a94-88c1-01a718a5b447';

        // Booking URLs
        const KYNREN_BOOKING_URL = "https://widget.smeetz.com/kynren";
        const PARK_ENTRY_BOOKING_URL = "https://widget.smeetz.com/park-entry";
        const COMBO_BOOKING_URL = "https://widget.smeetz.com/combo";

        const calendarGrid = document.getElementById('calendarGrid');
        const sideTab = document.getElementById('sideTab');
        const sideTabDate = document.getElementById('sideTabDate');
        const eventsView = document.getElementById('eventsView');
        const eventsPlaceholder = document.getElementById('eventsPlaceholder');
        const eventsList = document.getElementById('eventsList');
        const loadingStatus = document.getElementById('loadingStatus');
        const closeSideTabButton = document.getElementById('closeSideTab');
        const bookBothContainer = document.getElementById('bookBothContainer');
        const bookBothButton = document.getElementById('bookBothButton');

        const year = 2026;
        const month = 0; // January is 0 in JavaScript Date objects

        let sideTabHideTimeout;
        let selectedDateCell = null;
        let isSideTabFixed = false;
        const dateCellElements = {};

        async function fetchWithExponentialBackoff(url, options = {}, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i < retries - 1) {
                        console.warn(`Fetch failed, retrying in ${delay / 1000}s...`, error);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
        }

        async function fetchEventsForMonth(optionId, eventTitle, cacheObject, startMonthDate, endMonthDate) {
            const localDateTimeStart = `${startMonthDate}T00:00:00`;
            const localDateTimeEnd = `${endMonthDate}T23:59:59`;

            const apiUrl = `https://api-live.smeetz.com/v2/availabilities?optionIds=${optionId}&localDateTimeStart=${localDateTimeStart}&localDateTimeEnd=${localDateTimeEnd}&locale=en`;

            try {
                const data = await fetchWithExponentialBackoff(apiUrl, {
                    headers: {
                        'x-public-api-key': SMEETZ_API_KEY
                    }
                });

                for (const key in cacheObject) delete cacheObject[key];

                if (data.status === 'success' && data.data && data.data.length > 0) {
                    data.data.forEach(event => {
                        const eventDate = event.localDateTimeStart.split('T')[0];
                        if (event.available) {
                            if (!cacheObject[eventDate]) cacheObject[eventDate] = [];
                            cacheObject[eventDate].push({
                                startTime: new Date(event.localDateTimeStart).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                                endTime: new Date(event.localDateTimeEnd).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                                title: eventTitle,
                                type: eventTitle.toLowerCase().replace(/\s/g, ''),
                                id: event.id
                            });
                        }
                    });
                }
            } catch (error) {
                console.error(`Failed to fetch ${eventTitle} availabilities for January:`, error);
            }
        }

        async function initializeAllEventData() {
            const startMonthDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endMonthDate = `${year}-${String(month + 1).padStart(2, '0')}-${new Date(year, month + 1, 0).getDate()}`;

            loadingStatus.textContent = `Loading all event data for January...`;
            loadingStatus.classList.remove('hidden');

            await fetchEventsForMonth(KYREN_OPTION_ID, 'Kynren night show', kynrenAvailabilitiesCache, startMonthDate, endMonthDate);
            await fetchEventsForMonth(PARK_ENTRY_OPTION_ID, 'Park Entry', parkEntryAvailabilitiesCache, startMonthDate, endMonthDate);

            loadingStatus.textContent = "All event data loaded.";
            setTimeout(() => loadingStatus.classList.add('hidden'), 1000);
            updateAvailabilityIndicators();
        }

        function updateAvailabilityIndicators() {
            for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dateCell = dateCellElements[formattedDate];

                if (dateCell) {
                    const blueIndicator = dateCell.querySelector('.corner-indicator.blue');
                    const redIndicator = dateCell.querySelector('.corner-indicator.red');

                    if (blueIndicator) {
                        blueIndicator.classList.toggle('hidden-indicator', !(kynrenAvailabilitiesCache[formattedDate] && kynrenAvailabilitiesCache[formattedDate].length > 0));
                    }

                    if (redIndicator) {
                        redIndicator.classList.toggle('hidden-indicator', !(parkEntryAvailabilitiesCache[formattedDate] && parkEntryAvailabilitiesCache[formattedDate].length > 0));
                    }
                }
            }
        }

        function generateCalendar() {
            while (calendarGrid.children.length > 7) {
                calendarGrid.removeChild(calendarGrid.lastChild);
            }

            const firstDayOfMonthAdjusted = (new Date(year, month, 1).getDay() + 6) % 7;
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const dateCell = document.createElement('div');
                const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                dateCell.classList.add('date-cell');
                dateCell.textContent = day;
                dateCell.dataset.date = formattedDate;
                dateCellElements[formattedDate] = dateCell;

                if (day === 1) dateCell.style.gridColumnStart = firstDayOfMonthAdjusted + 1;

                const blueIndicator = document.createElement('div');
                blueIndicator.classList.add('corner-indicator', 'blue', 'hidden-indicator');
                dateCell.appendChild(blueIndicator);

                const redIndicator = document.createElement('div');
                redIndicator.classList.add('corner-indicator', 'red', 'hidden-indicator');
                dateCell.appendChild(redIndicator);

                const today = new Date();
                if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === day) {
                    dateCell.classList.add('today');
                }

                dateCell.addEventListener('mouseover', handleDateHover);
                dateCell.addEventListener('mouseout', handleDateLeave);
                dateCell.addEventListener('click', handleDateClick);
                calendarGrid.appendChild(dateCell);
            }
            initializeAllEventData();
        }

        function displaySideTabContent(date) {
            sideTabDate.textContent = `Events for ${new Date(date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
            eventsList.innerHTML = '';
            eventsPlaceholder.classList.add('hidden');

            const kynrenEventsForDate = kynrenAvailabilitiesCache[date] || [];
            const parkEntryEventsForDate = parkEntryAvailabilitiesCache[date] || [];

            let hasEvents = false;

            // Display each Kynren event as a separate row
            kynrenEventsForDate.forEach(event => {
                hasEvents = true;
                const eventItem = document.createElement('div');
                eventItem.classList.add('event-item');
                const eventDetails = document.createElement('span');
                eventDetails.innerHTML = `<strong>Kynren (${event.startTime} - ${event.endTime}):</strong> night show`;
                eventItem.appendChild(eventDetails);

                const bookEventButton = document.createElement('button');
                bookEventButton.classList.add('event-book-button');
                bookEventButton.textContent = 'Book';
                bookEventButton.addEventListener('click', () => {
                    window.open(
                        `${KYNREN_BOOKING_URL}?date=${date}&time=${event.startTime}`,
                        "smeetzPopup",
                        "width=800,height=600,scrollbars=yes,resizable=yes"
                    );
                });
                
                eventItem.appendChild(bookEventButton);
                eventsList.appendChild(eventItem);
            });

            // Display Park Entry as a single row with first start and last end time
            if (parkEntryEventsForDate.length > 0) {
                hasEvents = true;
                const firstOpening = parkEntryEventsForDate[0].startTime;
                const lastClosure = parkEntryEventsForDate[parkEntryEventsForDate.length - 1].endTime;

                const eventItem = document.createElement('div');
                eventItem.classList.add('event-item');
                const eventDetails = document.createElement('span');
                eventDetails.innerHTML = `<strong>Park Entry (${firstOpening} - ${lastClosure}):</strong>`;
                eventItem.appendChild(eventDetails);

                const bookEventButton = document.createElement('button');
                bookEventButton.classList.add('event-book-button');
                bookEventButton.textContent = 'Book';
                bookEventButton.addEventListener('click', () => {
                    window.open(
                        `${PARK_ENTRY_BOOKING_URL}?date=${date}`,
                        "smeetzPopup",
                        "width=800,height=600,scrollbars=yes,resizable=yes"
                    );
                });
                eventItem.appendChild(bookEventButton);
                eventsList.appendChild(eventItem);
            }

            // Show "Book Both" container if both event types are available
            if (kynrenEventsForDate.length > 0 && parkEntryEventsForDate.length > 0) {
                bookBothContainer.classList.remove('hidden');
                bookBothButton.onclick = () => {
                    window.open(
                        `${COMBO_BOOKING_URL}?date=${date}`,
                        "smeetzPopup",
                        "width=800,height=600,scrollbars=yes,resizable=yes"
                    );
                };
            } else {
                bookBothContainer.classList.add('hidden');
            }

            if (!hasEvents) {
                eventsList.innerHTML = '<p class="text-gray-500">No events scheduled for this date.</p>';
                bookBothContainer.classList.add('hidden');
            }

            eventsView.classList.remove('hidden');
            sideTab.classList.add('show');
            loadingStatus.classList.add('hidden');
        }

        function handleDateHover(event) {
            if (!isSideTabFixed) {
                clearTimeout(sideTabHideTimeout);
                displaySideTabContent(event.currentTarget.dataset.date);
            }
        }

        function handleDateLeave() {
            if (!isSideTabFixed) {
                sideTabHideTimeout = setTimeout(() => {
                    if (!sideTab.matches(':hover')) sideTab.classList.remove('show');
                }, 200);
            }
        }

        function handleDateClick(event) {
            if (selectedDateCell) selectedDateCell.classList.remove('selected');
            selectedDateCell = event.currentTarget;
            selectedDateCell.classList.add('selected');
            isSideTabFixed = true;
            clearTimeout(sideTabHideTimeout);
            displaySideTabContent(selectedDateCell.dataset.date);
        }

        sideTab.addEventListener('mouseover', () => {
            clearTimeout(sideTabHideTimeout);
            sideTab.classList.add('show');
        });

        sideTab.addEventListener('mouseout', (event) => {
            if (!isSideTabFixed) {
                sideTabHideTimeout = setTimeout(() => {
                    if (!calendarGrid.contains(event.relatedTarget) && !sideTab.contains(event.relatedTarget)) {
                        sideTab.classList.remove('show');
                    }
                }, 200);
            }
        });

        closeSideTabButton.addEventListener('click', () => {
            sideTab.classList.remove('show');
            isSideTabFixed = false;
            if (selectedDateCell) {
                selectedDateCell.classList.remove('selected');
                selectedDateCell = null;
            }
        });

        window.onload = generateCalendar;
    </script>
</body>
</html>
